<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Agent</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #333;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 30px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .record-button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
      margin: 20px 0;
    }

    .record-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
    }

    .record-button:active {
      transform: translateY(0);
    }

    .record-button.recording {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      animation: pulse 1.5s infinite;
    }

    .record-button.recording::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%) scale(0);
      animation: ripple 1.5s infinite;
    }

    .record-button.processing {
      background: linear-gradient(45deg, #f39c12, #e67e22);
      animation: spin 1s linear infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes ripple {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status {
      min-height: 60px;
      padding: 15px;
      margin-top: 20px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      color: #555;
    }

    .status.active {
      background: rgba(102, 126, 234, 0.15);
      border-left: 4px solid #667eea;
    }

    .conversation {
      text-align: left;
      white-space: pre-line;
    }

    .user-message {
      color: #667eea;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .bot-message {
      color: #333;
    }

    .hidden {
      display: none;
    }

    .audio-player {
      display: none;
    }

    @media (max-width: 480px) {
      .container {
        padding: 30px 20px;
        margin: 20px;
      }

      .record-button {
        width: 100px;
        height: 100px;
        font-size: 14px;
      }

      .title {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Voice Agent</h1>
    
    <button id="record-button" class="record-button">
      <span id="button-text">Tap to Talk</span>
    </button>
    
    <div id="status" class="status">
      Ready to listen. Tap the button to start your first message.
    </div>
    
    <audio id="audio-player" class="audio-player" autoplay></audio>
  </div>

  <script>
    let mediaRecorder;
    let recordedChunks = [];
    let sessionId;
    let isRecording = false;
    let isProcessing = false;

    // Generate or fetch session id from query param
    function getSessionId() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has("session_id")) {
        return urlParams.get("session_id");
      }
      const newId = Math.random().toString(36).substring(2, 10);
      urlParams.set("session_id", newId);
      window.history.replaceState({}, "", `${location.pathname}?${urlParams}`);
      return newId;
    }
    sessionId = getSessionId();

    const recordButton = document.getElementById('record-button');
    const buttonText = document.getElementById('button-text');
    const audioPlayer = document.getElementById('audio-player');
    const statusDiv = document.getElementById('status');

    function updateStatus(message, isActive = false) {
      statusDiv.textContent = message;
      statusDiv.classList.toggle('active', isActive);
    }

    function updateButtonState(state) {
      recordButton.className = 'record-button ' + state;
      
      switch(state) {
        case 'recording':
          buttonText.textContent = 'Listening...';
          break;
        case 'processing':
          buttonText.textContent = 'Thinking...';
          break;
        default:
          buttonText.textContent = 'Tap to Talk';
      }
    }

    recordButton.addEventListener('click', async () => {
      if (isProcessing) return;
      
      if (!isRecording) {
        await startRecording();
      } else {
        stopRecording();
      }
    });

    async function startRecording() {
      try {
        recordedChunks = [];
        updateStatus("Listening... Speak now!", true);
        updateButtonState('recording');

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = event => {
          if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          isProcessing = true;
          updateButtonState('processing');
          updateStatus("Processing your message...", true);

          const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append('file', audioBlob, 'recording.webm');

          try {
            const response = await fetch(`/agent/chat/${sessionId}`, {
              method: 'POST',
              body: formData
            });
            const data = await response.json();

            if (data.audio_url) {
              audioPlayer.src = data.audio_url;
              
              const conversationText = `You: ${data.user_transcript || 'Audio message'}\n\nAgent: ${data.bot_text}`;
              statusDiv.innerHTML = `<div class="conversation"><div class="user-message">You: ${data.user_transcript || 'Audio message'}</div><div class="bot-message">Agent: ${data.bot_text}</div></div>`;
              statusDiv.classList.add('active');

              audioPlayer.onloadeddata = () => {
                audioPlayer.play().catch(e => console.log('Autoplay prevented:', e));
              };

              audioPlayer.onended = () => {
                updateStatus("Ready for your next message. Tap to continue the conversation.");
                updateButtonState('');
                isProcessing = false;
                
                // Automatically start recording for the next message
                setTimeout(() => {
                  if (!isRecording && !isProcessing) {
                    startRecording();
                  }
                }, 1000); // Small delay to allow user to process the response
              };

            } else {
              throw new Error(data.error || data.bot_text || "Unknown error");
            }
          } catch (err) {
            console.error('Error:', err);
            updateStatus("Sorry, I'm having trouble connecting right now. Please try again.");
            updateButtonState('');
            isProcessing = false;
            
            // Auto-restart recording after error too
            setTimeout(() => {
              if (!isRecording && !isProcessing) {
                startRecording();
              }
            }, 2000); // Longer delay after error
          }

          // Stop all audio tracks
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        isRecording = true;

      } catch (err) {
        console.error('Error accessing microphone:', err);
        updateStatus("Unable to access microphone. Please check permissions and try again.");
        updateButtonState('');
        isRecording = false;
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        isRecording = false;
      }
    }

    // Optional: Add keyboard shortcut (spacebar to toggle recording)
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !isProcessing) {
        e.preventDefault();
        recordButton.click();
      }
    });
  </script>
</body>
</html>
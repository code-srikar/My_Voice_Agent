<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Voice Agent (Day 16 - Streaming)</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
    }
    .container {
      width: 92%; max-width: 420px; background: rgba(255,255,255,0.95);
      padding: 32px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      text-align: center;
    }
    .title {
      font-size: 26px; font-weight: 800; margin-bottom: 16px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .desc { color: #666; margin-bottom: 18px; }
    .record-button {
      width: 120px; height: 120px; border-radius: 50%; border: none; cursor: pointer;
      background: linear-gradient(45deg, #667eea, #764ba2); color: white; font-weight: 700;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); transition: transform .2s ease;
      margin: 12px auto;
    }
    .record-button:hover { transform: translateY(-2px); }
    .record-button.recording { background: linear-gradient(45deg, #ff6b6b, #ee5a24); animation: pulse 1.4s infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    .status {
      margin-top: 18px; padding: 14px; background: rgba(102,126,234,0.1);
      border-radius: 12px; color: #333; white-space: pre-wrap; line-height: 1.45;
    }
    .status.active { border-left: 4px solid #667eea; background: rgba(102,126,234,0.18); }
    .meta { margin-top: 10px; color: #777; font-size: 13px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">Voice Agent — Streaming</h1>
    <p class="desc">Day 16: Stream mic audio to the server via WebSocket and save to file.</p>

    <button id="record-btn" class="record-button">
      <span id="btn-label">Start Streaming</span>
    </button>

    <div id="status" class="status">
      Ready. Click to start streaming your microphone.
    </div>
    <div id="meta" class="meta"></div>
  </div>

  <script>
    // --- Session ID in URL (kept from prior days)
    function ensureSessionId() {
      const url = new URL(window.location.href);
      let sid = url.searchParams.get("session_id");
      if (!sid) {
        sid = Math.random().toString(36).slice(2, 10);
        url.searchParams.set("session_id", sid);
        history.replaceState({}, "", url.toString());
      }
      return sid;
    }
    const sessionId = ensureSessionId();

    // UI elements
    const recordBtn = document.getElementById('record-btn');
    const btnLabel  = document.getElementById('btn-label');
    const statusBox = document.getElementById('status');
    const metaBox   = document.getElementById('meta');

    // State
    let mediaRecorder = null;
    let ws = null;
    let isRecording = false;
    let stream = null;

    function setStatus(msg, active = true) {
      statusBox.textContent = msg;
      statusBox.classList.toggle('active', active);
    }
    function setButton(recording) {
      isRecording = recording;
      recordBtn.classList.toggle('recording', recording);
      btnLabel.textContent = recording ? "Stop Streaming" : "Start Streaming";
    }

    function getWsUrl() {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      return `${proto}://${location.host}/ws/audio?session_id=${encodeURIComponent(sessionId)}`;
    }

    async function startStreaming() {
      try {
        // 1) Open WebSocket first
        ws = new WebSocket(getWsUrl());
        ws.binaryType = "arraybuffer";

        ws.onopen = () => {
          metaBox.textContent = `WebSocket connected (${new Date().toLocaleTimeString()}) • session_id=${sessionId}`;
        };
        ws.onclose = () => {
          metaBox.textContent = `WebSocket closed (${new Date().toLocaleTimeString()})`;
        };
        ws.onerror = (e) => {
          console.error("WS error", e);
          setStatus("WebSocket error. Please try again.", false);
        };

        // 2) Get mic
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // 3) Create MediaRecorder; use webm/opus (most supported)
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
          ? 'audio/webm;codecs=opus'
          : 'audio/webm';

        mediaRecorder = new MediaRecorder(stream, { mimeType });

        mediaRecorder.onstart = () => {
          setStatus("Streaming… Your audio is being saved on the server.", true);
          setButton(true);
        };

        mediaRecorder.ondataavailable = async (e) => {
          if (e.data && e.data.size > 0 && ws && ws.readyState === WebSocket.OPEN) {
            try {
              const buf = await e.data.arrayBuffer();
              ws.send(buf);
            } catch (err) {
              console.error("Send chunk failed:", err);
            }
          }
        };

        mediaRecorder.onstop = () => {
          setButton(false);
          setStatus("Stopped. Audio file was saved on the server. Start again when ready.", true);
          if (ws && ws.readyState === WebSocket.OPEN) {
            // Optional control message before closing
            ws.send("close");
            ws.close();
          }
          if (stream) {
            stream.getTracks().forEach(t => t.stop());
          }
          stream = null;
          mediaRecorder = null;
          ws = null;
        };

        // 4) Start recording and emit chunks every 250ms
        mediaRecorder.start(250);

      } catch (err) {
        console.error(err);
        setStatus("Failed to access mic or open WebSocket. Check permissions and try again.", false);
        setButton(false);
      }
    }

    function stopStreaming() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      } else {
        // Clean up just in case
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
        }
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
        }
        ws = null; stream = null; mediaRecorder = null;
        setButton(false);
        setStatus("Stopped.", false);
      }
    }

    recordBtn.addEventListener('click', () => {
      if (!isRecording) startStreaming();
      else stopStreaming();
    });

    // Optional: space key toggles
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        recordBtn.click();
      }
    });
  </script>
</body>
</html>
